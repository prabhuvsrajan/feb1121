node{

defbuildNumber = BUILD_NUMBER
stage("Git Clone"){
git url:'https://github.com/Velappan0219/java-web-app-docker.git',branch:'master'
    }

stage("Maven Clean Package"){

defmavenHome= tool name: "Maven",type: "maven"
sh "${mavenHome}/bin/mvn clean package"
    }

stage("Build Docker Image"){

sh "docker build -t velappanarumugam/java-web-app-docker:${buildNumber} ."
    }

stage("Docker Login And Push"){

withCredentials([string(credentialsId: 'Docker_remote', variable: 'Docker_remote')]) {
sh "docker login -u velappanarumugam -p ${Docker_remote} "
        }

sh "docker push velappanarumugam/java-web-app-docker:${buildNumber}"
    }

stage("Deploy Application As Docker Container In Docker Deployment "){

sshagent(['Docker_deploy']) {
sh "ssh -o StrictHostKeyChecking=no ubuntu@172.31.26.255 dockerrm -f javawebapp || true"

sh "ssh -o StrictHostKeyChecking=no ubuntu@172.31.26.255 docker run -d -p 8080:8080 --name javawebappvelappanarumugam/java-web-app-docker:${buildNumber}"
         }

    }
}

